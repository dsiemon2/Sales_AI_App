<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-people me-2"></i>Users</h1>
      <p class="text-muted mb-0">Manage team members</p>
    </div>
    <div class="d-flex align-items-center gap-3">
      ${userLimit ? `
        <div class="text-end">
          <small class="text-muted d-block">User Limit</small>
          <span class="badge ${userLimit.limit === -1 ? 'bg-success' : (userLimit.currentCount >= userLimit.limit ? 'bg-danger' : 'bg-primary')}">
            ${userLimit.limit === -1 ? 'Unlimited' : userLimit.currentCount + '/' + userLimit.limit}
          </span>
          ${userLimit.limit !== -1 && userLimit.currentCount >= userLimit.limit ? `
            <a href="${basePath}/pricing" class="btn btn-sm btn-outline-warning ms-2">
              <i class="bi bi-arrow-up-circle me-1"></i>Upgrade
            </a>
          ` : ''}
        </div>
      ` : ''}
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal"
        ${userLimit && userLimit.limit !== -1 && userLimit.currentCount >= userLimit.limit ? 'disabled' : ''}>
        <i class="bi bi-plus-lg me-1"></i> Add User
      </button>
    </div>
  </div>

  ${userLimit && userLimit.limit !== -1 && userLimit.currentCount >= userLimit.limit ? `
    <div class="alert alert-warning d-flex align-items-center mb-4">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <div>
        <strong>User Limit Reached</strong> - You've reached your plan's user limit (${userLimit.currentCount}/${userLimit.limit}).
        <a href="${basePath}/pricing" class="alert-link">Upgrade your plan</a> to add more users.
      </div>
    </div>
  ` : ''}

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Role</label>
          <select name="role" class="form-select">
            <option value="">All Roles</option>
            ${roles.map(r => `
              <option value="${r}" ${filters.role === r ? 'selected' : ''}>${r.replace('_', ' ')}</option>
            `).join('')}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="">All Statuses</option>
            <option value="active" ${filters.status === 'active' ? 'selected' : ''}>Active</option>
            <option value="inactive" ${filters.status === 'inactive' ? 'selected' : ''}>Inactive</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel me-1"></i> Filter</button>
          <a href="${basePath}/admin/users" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Users Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Sessions</th>
              <th>Status</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${users.length === 0 ? `
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                  <i class="bi bi-people fs-1 d-block mb-2"></i>
                  No users found
                </td>
              </tr>
            ` : users.map(u => `
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px;">
                      ${u.firstName ? u.firstName.charAt(0) : ''}${u.lastName ? u.lastName.charAt(0) : ''}
                    </div>
                    <div>
                      <div class="fw-semibold">${u.firstName} ${u.lastName}</div>
                      <small class="text-muted">${u.email}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="badge bg-${u.role === 'COMPANY_ADMIN' ? 'danger' : u.role === 'MANAGER' ? 'warning text-dark' : u.role === 'SUPERVISOR' ? 'info' : 'secondary'}">
                    ${u.role.replace('_', ' ')}
                  </span>
                </td>
                <td>${u._count.sessions}</td>
                <td>
                  <span class="badge ${u.isActive ? 'bg-success' : 'bg-secondary'}">
                    ${u.isActive ? 'Active' : 'Inactive'}
                  </span>
                  ${!u.emailVerified ? '<span class="badge bg-warning text-dark">Unverified</span>' : ''}
                </td>
                <td>
                  ${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleDateString() : '<span class="text-muted">Never</span>'}
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-secondary" onclick="editUser('${u.id}')"
                          data-bs-toggle="tooltip" title="Edit user">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-warning" onclick="resetPassword('${u.id}')"
                          data-bs-toggle="tooltip" title="Reset password">
                    <i class="bi bi-key"></i>
                  </button>
                  ${u.id !== user.id ? `
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')"
                            data-bs-toggle="tooltip" title="Delete user">
                      <i class="bi bi-trash"></i>
                    </button>
                  ` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    ${pagination.pages > 1 ? `
      <div class="card-footer">
        <nav>
          <ul class="pagination pagination-sm mb-0 justify-content-center">
            <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
              <a class="page-link" href="?page=${pagination.page - 1}&limit=${pagination.limit}&role=${filters.role || ''}&status=${filters.status || ''}">Previous</a>
            </li>
            ${Array.from({length: pagination.pages}, (_, i) => i + 1).map(i => `
              <li class="page-item ${pagination.page === i ? 'active' : ''}">
                <a class="page-link" href="?page=${i}&limit=${pagination.limit}&role=${filters.role || ''}&status=${filters.status || ''}">${i}</a>
              </li>
            `).join('')}
            <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
              <a class="page-link" href="?page=${pagination.page + 1}&limit=${pagination.limit}&role=${filters.role || ''}&status=${filters.status || ''}">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    ` : ''}
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addUserForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">First Name *</label>
              <input type="text" name="firstName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name *</label>
              <input type="text" name="lastName" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Email *</label>
              <input type="email" name="email" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Password *</label>
              <input type="password" name="password" class="form-control" required minlength="8">
              <small class="text-muted">Minimum 8 characters</small>
            </div>
            <div class="col-12">
              <label class="form-label">Role *</label>
              <select name="role" class="form-select" required>
                ${roles.map(r => `
                  <option value="${r}">${r.replace('_', ' ')}</option>
                `).join('')}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Create User</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editUserForm">
        <input type="hidden" name="id" id="editUserId">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">First Name *</label>
              <input type="text" name="firstName" id="editFirstName" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Last Name *</label>
              <input type="text" name="lastName" id="editLastName" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Role *</label>
              <select name="role" id="editRole" class="form-select" required>
                ${roles.map(r => `
                  <option value="${r}">${r.replace('_', ' ')}</option>
                `).join('')}
              </select>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input type="checkbox" name="isActive" class="form-check-input" id="editIsActive">
                <label class="form-check-label" for="editIsActive">Active</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-key me-2"></i>Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="resetPasswordForm">
        <input type="hidden" name="id" id="resetPasswordUserId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">New Password *</label>
            <input type="password" name="newPassword" id="newPassword" class="form-control" required minlength="8">
            <small class="text-muted">Minimum 8 characters</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Confirm Password *</label>
            <input type="password" name="confirmPassword" id="confirmPassword" class="form-control" required minlength="8">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning"><i class="bi bi-key me-1"></i> Reset Password</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const users = ${JSON.stringify(users)};
  const basePath = '${basePath}';

  function editUser(id) {
    const u = users.find(x => x.id === id);
    if (!u) return;

    document.getElementById('editUserId').value = u.id;
    document.getElementById('editFirstName').value = u.firstName || '';
    document.getElementById('editLastName').value = u.lastName || '';
    document.getElementById('editRole').value = u.role || 'TRAINEE';
    document.getElementById('editIsActive').checked = u.isActive;

    new bootstrap.Modal(document.getElementById('editUserModal')).show();
  }

  function resetPassword(id) {
    document.getElementById('resetPasswordUserId').value = id;
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
  }

  document.getElementById('addUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    try {
      const res = await fetch(basePath + '/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to create user');
    } catch (err) {
      alert('Error creating user');
    }
  });

  document.getElementById('editUserForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const id = document.getElementById('editUserId').value;
    const data = Object.fromEntries(new FormData(form));
    data.isActive = form.isActive.checked;

    try {
      const res = await fetch(basePath + '/admin/users/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to update user');
    } catch (err) {
      alert('Error updating user');
    }
  });

  document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('resetPasswordUserId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      alert('Passwords do not match');
      return;
    }

    try {
      const res = await fetch(basePath + '/admin/users/' + id + '/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });
      if (res.ok) {
        alert('Password reset successfully');
        bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
      } else {
        alert((await res.json()).error || 'Failed to reset password');
      }
    } catch (err) {
      alert('Error resetting password');
    }
  });

  async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
    try {
      const res = await fetch(basePath + '/admin/users/' + id, { method: 'DELETE' });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to delete user');
    } catch (err) {
      alert('Error deleting user');
    }
  }

  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
</script>

` }) %>
