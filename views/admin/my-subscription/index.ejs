<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-person-badge me-2"></i>My Subscription</h1>
      <p class="text-muted mb-0">View and manage your subscription</p>
    </div>
    <a href="${basePath}/admin/pricing" class="btn btn-outline-primary"><i class="bi bi-tags me-1"></i> View Plans</a>
  </div>

  <div class="row">
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-body" id="subscriptionDetails">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Plan Features</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush" id="featuresList">
            <li class="list-group-item">Loading features...</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-question-circle me-2"></i>Need Help?</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Questions about your subscription? Contact our support team.</p>
          <a href="mailto:billing@apexsales.ai" class="btn btn-outline-primary w-100"><i class="bi bi-envelope me-1"></i> Contact Billing Support</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const basePath = '${basePath}';

  document.addEventListener('DOMContentLoaded', loadSubscription);

  async function loadSubscription() {
    try {
      const res = await fetch(basePath + '/admin/my-subscription/api');
      const data = await res.json();
      if (data.success) {
        renderSubscription(data.subscription, data.company);
      } else {
        renderNoSubscription();
      }
    } catch (err) {
      console.error('Error loading subscription:', err);
      renderNoSubscription();
    }
  }

  function renderSubscription(sub, company) {
    const container = document.getElementById('subscriptionDetails');
    const tier = company?.subscriptionTier || sub?.tier || 'starter';
    const status = company?.subscriptionStatus || sub?.status || 'trial';
    const statusBadge = status === 'active' ? 'bg-success' : status === 'trial' || status === 'trialing' ? 'bg-warning text-dark' : 'bg-danger';

    const tiers = {
      starter: { name: 'Starter', price: 0, features: ['Basic AI Training', 'Up to 5 Users', 'Email Support'] },
      professional: { name: 'Professional', price: 49.99, features: ['Advanced AI Training', 'Up to 25 Users', 'Priority Support', 'Custom Scenarios', 'Analytics Dashboard'] },
      business: { name: 'Business', price: 149.99, features: ['Enterprise AI Training', 'Unlimited Users', 'Dedicated Support', 'Custom Integrations', 'Advanced Analytics', 'API Access'] },
      enterprise: { name: 'Enterprise', price: null, features: ['Full Platform Access', 'Unlimited Everything', '24/7 Support', 'White-label Options', 'Custom Development', 'SLA Guarantee'] }
    };

    const plan = tiers[tier] || tiers.starter;

    container.innerHTML = '<div class="d-flex justify-content-between align-items-start mb-4">' +
      '<div><h4>' + plan.name + '</h4><p class="text-muted">Your current subscription plan</p></div>' +
      '<span class="badge ' + statusBadge + ' fs-6">' + status.charAt(0).toUpperCase() + status.slice(1) + '</span>' +
      '</div>' +
      '<div class="row mb-4">' +
      '<div class="col-md-6"><h6 class="text-muted">Price</h6><h3>' + (plan.price === null ? 'Contact Us' : plan.price === 0 ? 'Free' : '$' + plan.price + '/mo') + '</h3></div>' +
      '<div class="col-md-6"><h6 class="text-muted">Billing Period</h6><p>Monthly</p></div>' +
      '</div>' +
      (sub?.currentPeriodStart ? '<div class="row mb-4"><div class="col-md-6"><h6 class="text-muted">Period Start</h6><p>' + new Date(sub.currentPeriodStart).toLocaleDateString() + '</p></div><div class="col-md-6"><h6 class="text-muted">Period End</h6><p>' + (sub.currentPeriodEnd ? new Date(sub.currentPeriodEnd).toLocaleDateString() : '-') + '</p></div></div>' : '') +
      (status === 'trial' || status === 'trialing' ? '<div class="alert alert-warning"><i class="bi bi-clock me-2"></i>Your trial ' + (company?.trialEndsAt || sub?.trialEndsAt ? 'ends on ' + new Date(company?.trialEndsAt || sub?.trialEndsAt).toLocaleDateString() : 'is active') + '</div>' : '') +
      '<div class="d-flex gap-2">' +
      (status !== 'canceled' ? '<button class="btn btn-outline-danger" onclick="cancelSubscription()"><i class="bi bi-x-circle me-1"></i> Cancel Subscription</button>' : '<button class="btn btn-success" onclick="resumeSubscription()"><i class="bi bi-arrow-repeat me-1"></i> Resume Subscription</button>') +
      '</div>';

    document.getElementById('featuresList').innerHTML = plan.features.map(f => '<li class="list-group-item"><i class="bi bi-check-circle text-success me-2"></i>' + f + '</li>').join('');
  }

  function renderNoSubscription() {
    document.getElementById('subscriptionDetails').innerHTML = '<div class="text-center py-5"><i class="bi bi-person-badge fs-1 text-muted"></i><h5 class="mt-3">No Active Subscription</h5><p class="text-muted">You are on the free tier.</p><a href="' + basePath + '/admin/pricing" class="btn btn-primary"><i class="bi bi-tags me-1"></i> View Plans</a></div>';
    document.getElementById('featuresList').innerHTML = '<li class="list-group-item"><i class="bi bi-check-circle text-success me-2"></i>Basic AI Training</li>';
  }

  async function cancelSubscription() {
    if (!confirm('Are you sure you want to cancel your subscription?')) return;
    try {
      const res = await fetch(basePath + '/admin/my-subscription/api/cancel', { method: 'POST' });
      const data = await res.json();
      if (data.success) { alert('Subscription cancelled.'); loadSubscription(); }
      else alert('Error: ' + (data.error || 'Failed to cancel'));
    } catch (err) { alert('Error: ' + err.message); }
  }

  async function resumeSubscription() {
    try {
      const res = await fetch(basePath + '/admin/my-subscription/api/resume', { method: 'POST' });
      const data = await res.json();
      if (data.success) { alert('Subscription resumed.'); loadSubscription(); }
      else alert('Error: ' + (data.error || 'Failed to resume'));
    } catch (err) { alert('Error: ' + err.message); }
  }
</script>

` }) %>
