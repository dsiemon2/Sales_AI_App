<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-key me-2"></i>Trial Codes</h1>
      <p class="text-muted mb-0">Create and manage trial access codes (Super Admin only)</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTrialCodeModal">
      <i class="bi bi-plus-lg me-1"></i> New Trial Code
    </button>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" class="form-select">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="expired">Expired</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel me-1"></i> Filter</button>
          <a href="${basePath}/admin/trial-codes" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Trial Codes Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Code</th>
              <th>Description</th>
              <th>Usage</th>
              <th>Trial Days</th>
              <th>Industry</th>
              <th>Expires</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="trialCodesTable">
            <!-- Populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Trial Code Modal -->
<div class="modal fade" id="addTrialCodeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-key me-2"></i>New Trial Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addTrialCodeForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Custom Code (optional)</label>
              <input type="text" name="customCode" class="form-control text-uppercase" placeholder="Leave blank to auto-generate" maxlength="20">
              <small class="text-muted">8-20 characters, letters and numbers only</small>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <input type="text" name="description" class="form-control" placeholder="e.g., Summer 2024 Promo">
            </div>
            <div class="col-md-6">
              <label class="form-label">Max Uses</label>
              <input type="number" name="maxUses" class="form-control" value="1" min="1">
            </div>
            <div class="col-md-6">
              <label class="form-label">Trial Days</label>
              <input type="number" name="daysValid" class="form-control" value="14" min="1">
            </div>
            <div class="col-12">
              <label class="form-label">Industry (optional)</label>
              <select name="industryId" id="addIndustrySelect" class="form-select">
                <option value="">Any Industry</option>
              </select>
              <small class="text-muted">Lock this trial to a specific industry</small>
            </div>
            <div class="col-12">
              <label class="form-label">Expires On (optional)</label>
              <input type="date" name="expiresAt" class="form-control">
              <small class="text-muted">Leave blank for no expiration</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Create Code</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Trial Code Modal -->
<div class="modal fade" id="editTrialCodeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Trial Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editTrialCodeForm">
        <input type="hidden" name="id" id="editTrialCodeId">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Code</label>
            <input type="text" id="editCode" class="form-control" disabled>
          </div>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Description</label>
              <input type="text" name="description" id="editDescription" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Max Uses</label>
              <input type="number" name="maxUses" id="editMaxUses" class="form-control" min="1">
            </div>
            <div class="col-md-6">
              <label class="form-label">Trial Days</label>
              <input type="number" name="daysValid" id="editDaysValid" class="form-control" min="1">
            </div>
            <div class="col-12">
              <label class="form-label">Industry</label>
              <select name="industryId" id="editIndustryId" class="form-select">
                <option value="">Any Industry</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Expires On</label>
              <input type="date" name="expiresAt" id="editExpiresAt" class="form-control">
            </div>
            <div class="col-12">
              <div class="form-check">
                <input type="checkbox" name="isActive" class="form-check-input" id="editIsActive">
                <label class="form-check-label" for="editIsActive">Active</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const trialCodes = ${JSON.stringify(trialCodes)};
  const industries = ${JSON.stringify(industries)};
  const basePath = '${basePath}';

  // Populate industries select
  function populateIndustries() {
    const addSelect = document.getElementById('addIndustrySelect');
    const editSelect = document.getElementById('editIndustryId');
    industries.forEach(ind => {
      addSelect.innerHTML += '<option value="' + ind.id + '">' + ind.name + '</option>';
      editSelect.innerHTML += '<option value="' + ind.id + '">' + ind.name + '</option>';
    });
  }

  // Render trial codes table
  function renderTable() {
    const tbody = document.getElementById('trialCodesTable');
    if (trialCodes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted"><i class="bi bi-key fs-1 d-block mb-2"></i>No trial codes found. Create one to get started.</td></tr>';
      return;
    }
    tbody.innerHTML = trialCodes.map(tc => {
      const industry = industries.find(i => i.id === tc.industryId);
      const isExpired = tc.expiresAt && new Date(tc.expiresAt) < new Date();
      const statusBadge = tc.isActive ?
        (isExpired ? '<span class="badge bg-danger">Expired</span>' : '<span class="badge bg-success">Active</span>') :
        '<span class="badge bg-secondary">Inactive</span>';
      return '<tr>' +
        '<td><code class="fs-6 user-select-all">' + tc.code + '</code> <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyCode(\\'' + tc.code + '\\')" data-bs-toggle="tooltip" title="Copy code"><i class="bi bi-clipboard"></i></button></td>' +
        '<td>' + (tc.description || '<span class="text-muted">-</span>') + '</td>' +
        '<td><span class="' + (tc.usedCount >= tc.maxUses ? 'text-danger' : '') + '">' + tc.usedCount + ' / ' + tc.maxUses + '</span></td>' +
        '<td>' + tc.daysValid + ' days</td>' +
        '<td>' + (industry ? industry.name : '<span class="text-muted">Any</span>') + '</td>' +
        '<td>' + (tc.expiresAt ? new Date(tc.expiresAt).toLocaleDateString() : '<span class="text-muted">Never</span>') + '</td>' +
        '<td>' + statusBadge + '</td>' +
        '<td>' +
          '<button class="btn btn-sm btn-outline-secondary" onclick="editTrialCode(\\'' + tc.id + '\\')" data-bs-toggle="tooltip" title="Edit"><i class="bi bi-pencil"></i></button> ' +
          '<button class="btn btn-sm btn-outline-' + (tc.isActive ? 'warning' : 'success') + '" onclick="toggleTrialCode(\\'' + tc.id + '\\')" data-bs-toggle="tooltip" title="' + (tc.isActive ? 'Deactivate' : 'Activate') + '"><i class="bi bi-' + (tc.isActive ? 'pause' : 'play') + '"></i></button> ' +
          '<button class="btn btn-sm btn-outline-danger" onclick="deleteTrialCode(\\'' + tc.id + '\\')" data-bs-toggle="tooltip" title="Delete"><i class="bi bi-trash"></i></button>' +
        '</td>' +
      '</tr>';
    }).join('');
  }

  function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
      alert('Code copied: ' + code);
    });
  }

  function editTrialCode(id) {
    const tc = trialCodes.find(x => x.id === id);
    if (!tc) return;
    document.getElementById('editTrialCodeId').value = tc.id;
    document.getElementById('editCode').value = tc.code;
    document.getElementById('editDescription').value = tc.description || '';
    document.getElementById('editMaxUses').value = tc.maxUses;
    document.getElementById('editDaysValid').value = tc.daysValid;
    document.getElementById('editIndustryId').value = tc.industryId || '';
    document.getElementById('editExpiresAt').value = tc.expiresAt ? tc.expiresAt.split('T')[0] : '';
    document.getElementById('editIsActive').checked = tc.isActive;
    new bootstrap.Modal(document.getElementById('editTrialCodeModal')).show();
  }

  document.getElementById('addTrialCodeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(e.target));
    try {
      const res = await fetch(basePath + '/admin/trial-codes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (res.ok) {
        alert('Trial code created: ' + result.trialCode.code);
        location.reload();
      } else {
        alert(result.error || 'Failed to create trial code');
      }
    } catch (err) {
      alert('Error creating trial code');
    }
  });

  document.getElementById('editTrialCodeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const id = document.getElementById('editTrialCodeId').value;
    const data = Object.fromEntries(new FormData(form));
    data.isActive = form.isActive.checked;
    try {
      const res = await fetch(basePath + '/admin/trial-codes/' + id, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to update trial code');
    } catch (err) {
      alert('Error updating trial code');
    }
  });

  async function toggleTrialCode(id) {
    try {
      const res = await fetch(basePath + '/admin/trial-codes/' + id + '/toggle', { method: 'POST' });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to toggle trial code');
    } catch (err) {
      alert('Error toggling trial code');
    }
  }

  async function deleteTrialCode(id) {
    if (!confirm('Are you sure you want to delete this trial code?')) return;
    try {
      const res = await fetch(basePath + '/admin/trial-codes/' + id, { method: 'DELETE' });
      if (res.ok) location.reload();
      else alert((await res.json()).error || 'Failed to delete trial code');
    } catch (err) {
      alert('Error deleting trial code');
    }
  }

  // Initialize
  populateIndustries();
  renderTable();
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
</script>

` }) %>
