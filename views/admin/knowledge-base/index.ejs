<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-book me-2"></i>Knowledge Base</h1>
      <p class="text-muted mb-0">Manage training content and reference materials for AI</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#articleModal" id="addArticleBtn">
      <i class="bi bi-plus-lg me-1"></i> Add Article
    </button>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body py-3">
      <form method="GET" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label small text-muted">Search</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="search" class="form-control" placeholder="Search articles..."
              value="${filters?.search || ''}">
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label small text-muted">Category</label>
          <select name="category" class="form-select" id="categoryFilter">
            <option value="all">All Categories</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-funnel me-1"></i>Filter
          </button>
        </div>
        <div class="col-md-2">
          <a href="${basePath}/admin/knowledge-base" class="btn btn-outline-secondary w-100">
            <i class="bi bi-x-lg me-1"></i>Clear
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Articles Grid -->
  <div class="row g-4" id="articlesGrid">
    <!-- Articles will be rendered by JavaScript -->
  </div>
</div>

<!-- Article Modal -->
<div class="modal fade" id="articleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"><i class="bi bi-plus-lg me-2"></i>Add Article</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="articleForm" method="POST">
        <div class="modal-body">
          <input type="hidden" name="_method" id="formMethod" value="POST">
          <input type="hidden" name="articleId" id="articleId" value="">

          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Title <span class="text-danger">*</span></label>
              <input type="text" name="title" id="articleTitle" class="form-control" required
                placeholder="Article title">
            </div>
            <div class="col-md-4">
              <label class="form-label">Category</label>
              <input type="text" name="category" id="articleCategory" class="form-control"
                list="categoryList" placeholder="e.g., products, faq">
              <datalist id="categoryList">
                <option value="general">
                <option value="products">
                <option value="faq">
                <option value="policies">
                <option value="procedures">
              </datalist>
            </div>
            <div class="col-12">
              <label class="form-label">Content <span class="text-danger">*</span></label>
              <textarea name="content" id="articleContent" class="form-control" rows="10" required
                placeholder="Article content..."></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tags (comma-separated)</label>
              <input type="text" name="tagsInput" id="articleTags" class="form-control"
                placeholder="e.g., pricing, features, support">
            </div>
            <div class="col-md-3">
              <label class="form-label">Sort Order</label>
              <input type="number" name="sortOrder" id="articleSortOrder" class="form-control" value="0">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="isActive" id="articleActive" checked>
                <label class="form-check-label" for="articleActive">Active</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-save me-1"></i> Save Article
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
const basePath = '${basePath}';
const token = '${token || ''}';
const articles = ${JSON.stringify(articles || [])};
const categories = ${JSON.stringify(categories || ['general', 'products', 'faq', 'policies', 'procedures'])};
const filters = ${JSON.stringify(filters || {})};

// Render articles on page load
function renderArticles() {
  const grid = document.getElementById('articlesGrid');

  if (!articles || articles.length === 0) {
    grid.innerHTML = '<div class="col-12"><div class="card"><div class="card-body text-center py-5 text-muted"><i class="bi bi-book fs-1 d-block mb-3"></i><h5>No articles yet</h5><p>Add articles to build your AI knowledge base.</p><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#articleModal"><i class="bi bi-plus-lg me-1"></i>Add First Article</button></div></div></div>';
    return;
  }

  let html = '';
  articles.forEach(article => {
    const tags = (article.tags || []).map(tag => '<span class="badge bg-light text-dark">' + tag + '</span>').join('');
    const contentPreview = article.content ? article.content.substring(0, 200) + (article.content.length > 200 ? '...' : '') : '';
    const dateStr = article.updatedAt ? new Date(article.updatedAt).toLocaleDateString() : '';

    html += '<div class="col-lg-4 col-md-6">' +
      '<div class="card h-100 ' + (!article.isActive ? 'border-warning' : '') + '">' +
        '<div class="card-header d-flex align-items-center justify-content-between py-2">' +
          '<span class="badge bg-primary">' + (article.category || 'general') + '</span>' +
          '<div class="form-check form-switch mb-0">' +
            '<input class="form-check-input toggle-active" type="checkbox" data-id="' + article.id + '"' + (article.isActive ? ' checked' : '') + '>' +
          '</div>' +
        '</div>' +
        '<div class="card-body">' +
          '<h5 class="card-title">' + article.title + '</h5>' +
          '<p class="card-text text-muted small" style="max-height: 100px; overflow: hidden;">' + contentPreview + '</p>' +
          '<div class="d-flex flex-wrap gap-1 mt-2">' + tags + '</div>' +
        '</div>' +
        '<div class="card-footer bg-transparent d-flex justify-content-between align-items-center">' +
          '<small class="text-muted"><i class="bi bi-calendar me-1"></i>' + dateStr + '</small>' +
          '<div>' +
            '<button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="' + article.id + '" data-bs-toggle="tooltip" title="Edit">' +
              '<i class="bi bi-pencil"></i>' +
            '</button>' +
            '<button class="btn btn-sm btn-outline-danger delete-btn" data-id="' + article.id + '" data-bs-toggle="tooltip" title="Delete">' +
              '<i class="bi bi-trash"></i>' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  grid.innerHTML = html;

  // Initialize tooltips
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
  });

  // Attach event listeners
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      editArticle(this.dataset.id);
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      deleteArticle(this.dataset.id);
    });
  });

  document.querySelectorAll('.toggle-active').forEach(input => {
    input.addEventListener('change', function() {
      toggleArticle(this.dataset.id, this);
    });
  });
}

// Populate category filter
function populateCategoryFilter() {
  const select = document.getElementById('categoryFilter');
  categories.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    if (filters.category === c) opt.selected = true;
    select.appendChild(opt);
  });
}

function resetForm() {
  document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-lg me-2"></i>Add Article';
  document.getElementById('formMethod').value = 'POST';
  document.getElementById('articleId').value = '';
  document.getElementById('articleForm').reset();
  document.getElementById('articleActive').checked = true;
}

function editArticle(id) {
  window.location.href = basePath + '/admin/knowledge-base/' + id + '/edit?token=' + token;
}

async function toggleArticle(id, checkbox) {
  try {
    const response = await fetch(basePath + '/admin/knowledge-base/' + id + '/toggle', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) throw new Error('Failed to toggle');

    const result = await response.json();
    checkbox.closest('.card').classList.toggle('border-warning', !result.isActive);
  } catch (error) {
    alert('Error: ' + error.message);
    checkbox.checked = !checkbox.checked;
  }
}

async function deleteArticle(id) {
  if (!confirm('Are you sure you want to delete this article?')) return;

  try {
    const response = await fetch(basePath + '/admin/knowledge-base/' + id, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) throw new Error('Failed to delete');

    window.location.reload();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

document.getElementById('articleForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const formData = new FormData(e.target);
  const data = {
    title: formData.get('title'),
    content: formData.get('content'),
    category: formData.get('category') || 'general',
    tags: JSON.stringify((formData.get('tagsInput') || '').split(',').map(t => t.trim()).filter(t => t)),
    sortOrder: formData.get('sortOrder') || '0',
    isActive: document.getElementById('articleActive').checked
  };

  try {
    const response = await fetch(basePath + '/admin/knowledge-base', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) throw new Error('Failed to save');

    window.location.reload();
  } catch (error) {
    alert('Error: ' + error.message);
  }
});

document.getElementById('addArticleBtn').addEventListener('click', resetForm);

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  renderArticles();
  populateCategoryFilter();
});
</script>

` }) %>
