<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-link-45deg me-2"></i>Webhooks</h1>
      <p class="text-muted mb-0">Configure external integrations and event notifications</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#webhookModal" id="addWebhookBtn">
      <i class="bi bi-plus-lg me-1"></i> Add Webhook
    </button>
  </div>

  <!-- Webhooks List -->
  <div class="row g-4" id="webhooksGrid">
    <!-- Rendered by JavaScript -->
  </div>
</div>

<!-- Webhook Modal -->
<div class="modal fade" id="webhookModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"><i class="bi bi-plus-lg me-2"></i>Add Webhook</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="webhookForm">
        <div class="modal-body">
          <input type="hidden" id="webhookId" value="">

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" name="name" id="webhookName" class="form-control" required
                placeholder="My Integration">
            </div>
            <div class="col-md-6">
              <label class="form-label">URL <span class="text-danger">*</span></label>
              <input type="url" name="url" id="webhookUrl" class="form-control" required
                placeholder="https://example.com/webhook">
            </div>
            <div class="col-12">
              <label class="form-label">Events <span class="text-danger">*</span></label>
              <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;" id="eventsContainer">
                <!-- Events rendered by JS -->
              </div>
              <small class="text-muted">Select which events should trigger this webhook.</small>
            </div>
            <div class="col-12">
              <label class="form-label">Secret (Optional)</label>
              <input type="text" name="secret" id="webhookSecret" class="form-control"
                placeholder="HMAC signing secret for payload verification">
              <small class="text-muted">If provided, payloads will be signed with X-Webhook-Signature header.</small>
            </div>
            <div class="col-12">
              <label class="form-label">Custom Headers (Optional)</label>
              <textarea name="headers" id="webhookHeaders" class="form-control" rows="3"
                placeholder='{"Authorization": "Bearer token123"}'></textarea>
              <small class="text-muted">JSON object with custom headers to include in requests.</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-save me-1"></i> Save Webhook
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Deliveries Modal -->
<div class="modal fade" id="deliveriesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-list me-2"></i>Delivery History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="deliveriesList" class="list-group">
          <div class="text-center py-4 text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const basePath = '${basePath}';
const webhooksData = ${JSON.stringify(webhooks || [])};
const eventTypes = ${JSON.stringify(eventTypes || ['session.created', 'session.completed', 'user.created', 'user.updated', 'sale.completed', 'payment.received'])};

function renderWebhooks() {
  const grid = document.getElementById('webhooksGrid');

  if (!webhooksData || webhooksData.length === 0) {
    grid.innerHTML = '<div class="col-12"><div class="card"><div class="card-body text-center py-5 text-muted"><i class="bi bi-link-45deg fs-1 d-block mb-3"></i><h5>No webhooks configured</h5><p>Add webhooks to receive real-time notifications when events occur.</p><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#webhookModal"><i class="bi bi-plus-lg me-1"></i>Add First Webhook</button></div></div></div>';
    return;
  }

  let html = '';
  webhooksData.forEach(webhook => {
    const events = (webhook.events || []).slice(0, 5).map(e => '<span class="badge bg-primary bg-opacity-25 text-primary">' + e + '</span>').join('');
    const moreEvents = (webhook.events || []).length > 5 ? '<span class="badge bg-light text-dark">+' + ((webhook.events || []).length - 5) + ' more</span>' : '';
    const lastTriggered = webhook.lastTriggered ? '<i class="bi bi-clock me-1"></i>Last: ' + new Date(webhook.lastTriggered).toLocaleString() : 'Never triggered';

    html += '<div class="col-lg-6">' +
      '<div class="card h-100 ' + (!webhook.isActive ? 'border-warning' : '') + '">' +
        '<div class="card-header d-flex align-items-center justify-content-between py-2">' +
          '<div>' +
            '<span class="badge ' + (webhook.isActive ? 'bg-success' : 'bg-warning') + ' me-2">' + (webhook.isActive ? 'Active' : 'Inactive') + '</span>' +
            '<span class="badge bg-secondary">' + (webhook.failCount > 0 ? webhook.failCount + ' failures' : 'Healthy') + '</span>' +
          '</div>' +
          '<div class="form-check form-switch mb-0">' +
            '<input class="form-check-input toggle-webhook" type="checkbox" data-id="' + webhook.id + '"' + (webhook.isActive ? ' checked' : '') + '>' +
          '</div>' +
        '</div>' +
        '<div class="card-body">' +
          '<h5 class="card-title">' + webhook.name + '</h5>' +
          '<p class="card-text small text-muted text-truncate" title="' + webhook.url + '">' +
            '<i class="bi bi-link me-1"></i>' + webhook.url +
          '</p>' +
          '<div class="mb-2">' +
            '<small class="text-muted">Events:</small>' +
            '<div class="d-flex flex-wrap gap-1 mt-1">' + events + moreEvents + '</div>' +
          '</div>' +
          (webhook.secret ? '<small class="text-success"><i class="bi bi-shield-check me-1"></i>HMAC Signed</small>' : '') +
        '</div>' +
        '<div class="card-footer bg-transparent d-flex justify-content-between align-items-center">' +
          '<small class="text-muted">' + lastTriggered + '</small>' +
          '<div>' +
            '<button class="btn btn-sm btn-outline-info me-1 test-btn" data-id="' + webhook.id + '" data-bs-toggle="tooltip" title="Test"><i class="bi bi-play"></i></button>' +
            '<button class="btn btn-sm btn-outline-secondary me-1 history-btn" data-id="' + webhook.id + '" data-bs-toggle="tooltip" title="Delivery History"><i class="bi bi-list"></i></button>' +
            '<button class="btn btn-sm btn-outline-primary me-1 edit-btn" data-id="' + webhook.id + '" data-bs-toggle="tooltip" title="Edit"><i class="bi bi-pencil"></i></button>' +
            '<button class="btn btn-sm btn-outline-danger delete-btn" data-id="' + webhook.id + '" data-bs-toggle="tooltip" title="Delete"><i class="bi bi-trash"></i></button>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  grid.innerHTML = html;

  // Initialize tooltips and attach event listeners
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

  document.querySelectorAll('.toggle-webhook').forEach(el => {
    el.addEventListener('change', function() { toggleWebhook(this.dataset.id, this); });
  });
  document.querySelectorAll('.edit-btn').forEach(el => {
    el.addEventListener('click', function() { editWebhook(this.dataset.id); });
  });
  document.querySelectorAll('.delete-btn').forEach(el => {
    el.addEventListener('click', function() { deleteWebhook(this.dataset.id); });
  });
  document.querySelectorAll('.test-btn').forEach(el => {
    el.addEventListener('click', function() { testWebhook(this.dataset.id, this); });
  });
  document.querySelectorAll('.history-btn').forEach(el => {
    el.addEventListener('click', function() { viewDeliveries(this.dataset.id); });
  });
}

function renderEventTypes() {
  const container = document.getElementById('eventsContainer');
  let html = '';
  eventTypes.forEach((event, i) => {
    html += '<div class="form-check form-check-inline">' +
      '<input class="form-check-input event-checkbox" type="checkbox" id="event_' + i + '" value="' + event + '">' +
      '<label class="form-check-label small" for="event_' + i + '">' + event + '</label>' +
    '</div>';
  });
  container.innerHTML = html;
}

function resetForm() {
  document.getElementById('modalTitle').innerHTML = '<i class="bi bi-plus-lg me-2"></i>Add Webhook';
  document.getElementById('webhookId').value = '';
  document.getElementById('webhookForm').reset();
  document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = false);
}

function editWebhook(id) {
  const webhook = webhooksData.find(w => w.id === id);
  if (!webhook) return;

  document.getElementById('modalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Webhook';
  document.getElementById('webhookId').value = webhook.id;
  document.getElementById('webhookName').value = webhook.name;
  document.getElementById('webhookUrl').value = webhook.url;
  document.getElementById('webhookSecret').value = webhook.secret || '';
  document.getElementById('webhookHeaders').value = webhook.headers ? JSON.stringify(webhook.headers, null, 2) : '';

  document.querySelectorAll('.event-checkbox').forEach(cb => {
    cb.checked = (webhook.events || []).includes(cb.value);
  });

  new bootstrap.Modal(document.getElementById('webhookModal')).show();
}

async function toggleWebhook(id, checkbox) {
  try {
    const response = await fetch(basePath + '/admin/webhooks/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ isActive: checkbox.checked })
    });
    if (!response.ok) throw new Error('Failed to update');
    checkbox.closest('.card').classList.toggle('border-warning', !checkbox.checked);
  } catch (error) {
    alert('Error: ' + error.message);
    checkbox.checked = !checkbox.checked;
  }
}

async function deleteWebhook(id) {
  if (!confirm('Are you sure you want to delete this webhook?')) return;

  try {
    const response = await fetch(basePath + '/admin/webhooks/' + id, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    if (!response.ok) throw new Error('Failed to delete');
    window.location.reload();
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

async function testWebhook(id, btn) {
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

  try {
    const response = await fetch(basePath + '/admin/webhooks/' + id + '/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const result = await response.json();

    if (result.success) {
      alert('Test successful! Status: ' + result.statusCode);
    } else {
      alert('Test failed: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-play"></i>';
  }
}

async function viewDeliveries(id) {
  const listEl = document.getElementById('deliveriesList');
  listEl.innerHTML = '<div class="text-center py-4 text-muted">Loading...</div>';
  new bootstrap.Modal(document.getElementById('deliveriesModal')).show();

  try {
    const response = await fetch(basePath + '/admin/webhooks/' + id + '/deliveries?limit=20');
    const data = await response.json();
    const deliveries = data.deliveries || [];

    if (deliveries.length === 0) {
      listEl.innerHTML = '<div class="text-center py-4 text-muted">No deliveries yet</div>';
      return;
    }

    let html = '';
    deliveries.forEach(d => {
      html += '<div class="list-group-item">' +
        '<div class="d-flex justify-content-between align-items-start">' +
          '<div>' +
            '<span class="badge ' + (d.deliveredAt ? 'bg-success' : 'bg-danger') + ' me-2">' + (d.deliveredAt ? 'Delivered' : 'Failed') + '</span>' +
            '<strong>' + d.eventType + '</strong>' +
            (d.statusCode ? '<span class="badge bg-secondary ms-2">HTTP ' + d.statusCode + '</span>' : '') +
          '</div>' +
          '<small class="text-muted">' + new Date(d.createdAt).toLocaleString() + '</small>' +
        '</div>' +
        (d.error ? '<small class="text-danger d-block mt-1">' + d.error + '</small>' : '') +
      '</div>';
    });
    listEl.innerHTML = html;
  } catch (error) {
    listEl.innerHTML = '<div class="text-center py-4 text-danger">Error loading deliveries</div>';
  }
}

document.getElementById('webhookForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const id = document.getElementById('webhookId').value;
  const events = Array.from(document.querySelectorAll('.event-checkbox:checked')).map(cb => cb.value);

  if (events.length === 0) {
    alert('Please select at least one event.');
    return;
  }

  let headers = {};
  const headersStr = document.getElementById('webhookHeaders').value.trim();
  if (headersStr) {
    try {
      headers = JSON.parse(headersStr);
    } catch (e) {
      alert('Invalid JSON in custom headers');
      return;
    }
  }

  const data = {
    name: document.getElementById('webhookName').value,
    url: document.getElementById('webhookUrl').value,
    events: events,
    secret: document.getElementById('webhookSecret').value || null,
    headers: headers
  };

  try {
    const response = await fetch(basePath + '/admin/webhooks' + (id ? '/' + id : ''), {
      method: id ? 'PUT' : 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const result = await response.json();
      throw new Error(result.error || 'Failed to save');
    }

    window.location.reload();
  } catch (error) {
    alert('Error: ' + error.message);
  }
});

document.getElementById('addWebhookBtn').addEventListener('click', resetForm);

document.addEventListener('DOMContentLoaded', () => {
  renderWebhooks();
  renderEventTypes();
});
</script>

` }) %>
