<%- include('../../layouts/admin', { body: `

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-0"><i class="bi bi-megaphone me-2"></i>Announcements</h1>
      <p class="text-muted mb-0">Manage announcement bars across industries</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAnnouncementModal">
      <i class="bi bi-plus-lg me-1"></i> Add Announcement
    </button>
  </div>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" id="filterForm" class="row g-3 align-items-end">
        <input type="hidden" name="token" value="${token || ''}">
        <div class="col-md-4">
          <label class="form-label">Industry</label>
          <select name="industryId" id="industryFilter" class="form-select">
            <option value="">All Industries</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select name="status" id="statusFilter" class="form-select">
            <option value="">All Status</option>
            <option value="active" ${filters?.status === 'active' ? 'selected' : ''}>Active</option>
            <option value="inactive" ${filters?.status === 'inactive' ? 'selected' : ''}>Inactive</option>
            <option value="scheduled" ${filters?.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary me-2"><i class="bi bi-funnel me-1"></i> Filter</button>
          <a href="${basePath}/admin/announcements?token=${token || ''}" class="btn btn-outline-secondary">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Global Settings -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Global Settings</h5>
    </div>
    <div class="card-body">
      <form id="globalSettingsForm" class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Rotation Speed (ms)</label>
          <input type="number" name="rotationSpeed" class="form-control" value="${globalSettings?.rotationSpeed || 5000}" min="1000" max="30000" step="500">
        </div>
        <div class="col-md-3">
          <label class="form-label">Animation Style</label>
          <select name="animationStyle" class="form-select">
            <option value="fade" ${globalSettings?.animationStyle === 'fade' ? 'selected' : ''}>Fade</option>
            <option value="slide" ${globalSettings?.animationStyle === 'slide' ? 'selected' : ''}>Slide</option>
            <option value="none" ${globalSettings?.animationStyle === 'none' ? 'selected' : ''}>None</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="allowDismissGlobal" name="allowDismissGlobal" ${globalSettings?.allowDismissGlobal !== false ? 'checked' : ''}>
            <label class="form-check-label" for="allowDismissGlobal">Allow Dismiss</label>
          </div>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-check-lg me-1"></i> Save Settings
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Announcements Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 50px;"><i class="bi bi-grip-vertical text-muted"></i></th>
              <th>Announcement</th>
              <th>Industry</th>
              <th>Schedule</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="announcementsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Add Announcement Modal -->
<div class="modal fade" id="addAnnouncementModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Add Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="addAnnouncementForm">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Industry</label>
              <select name="industryId" class="form-select" id="addIndustrySelect">
                <option value="">All Industries (Global)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Icon</label>
              <input type="text" name="icon" class="form-control" value="bi-megaphone" placeholder="bi-megaphone">
              <small class="text-muted">Bootstrap Icons class</small>
            </div>
            <div class="col-12">
              <label class="form-label">Announcement Text <span class="text-danger">*</span></label>
              <textarea name="text" class="form-control" rows="2" required placeholder="Enter announcement text..."></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Background Color</label>
              <div class="input-group">
                <input type="color" name="bgColor" class="form-control form-control-color" value="#2563eb">
                <input type="text" class="form-control color-text" value="#2563eb" readonly>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Text Color</label>
              <div class="input-group">
                <input type="color" name="textColor" class="form-control form-control-color" value="#ffffff">
                <input type="text" class="form-control color-text" value="#ffffff" readonly>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Position</label>
              <select name="position" class="form-select">
                <option value="top">Top</option>
                <option value="bottom">Bottom</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Link URL</label>
              <input type="url" name="linkUrl" class="form-control" placeholder="https://...">
            </div>
            <div class="col-md-6">
              <label class="form-label">Link Text</label>
              <input type="text" name="linkText" class="form-control" placeholder="Learn More">
            </div>
            <div class="col-md-6">
              <label class="form-label">Start Date</label>
              <input type="datetime-local" name="startDate" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">End Date</label>
              <input type="datetime-local" name="endDate" class="form-control">
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="addIsActive" name="isActive" checked>
                <label class="form-check-label" for="addIsActive">Active</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="addAllowDismiss" name="allowDismiss" checked>
                <label class="form-check-label" for="addAllowDismiss">Allow Dismiss</label>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Preview</label>
              <div id="addPreview" class="p-3 text-center rounded" style="background: #2563eb; color: #ffffff;">
                <i class="bi bi-megaphone me-2"></i>
                <span id="addPreviewText">Enter announcement text...</span>
                <a href="#" class="ms-2 text-white" id="addPreviewLink" style="display: none;">Learn More</a>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Create Announcement</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="editAnnouncementForm">
        <input type="hidden" name="id" id="editId">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Industry</label>
              <select name="industryId" class="form-select" id="editIndustrySelect">
                <option value="">All Industries (Global)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Icon</label>
              <input type="text" name="icon" id="editIcon" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Announcement Text <span class="text-danger">*</span></label>
              <textarea name="text" id="editText" class="form-control" rows="2" required></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Background Color</label>
              <div class="input-group">
                <input type="color" name="bgColor" id="editBgColor" class="form-control form-control-color">
                <input type="text" class="form-control color-text" id="editBgColorText" readonly>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Text Color</label>
              <div class="input-group">
                <input type="color" name="textColor" id="editTextColor" class="form-control form-control-color">
                <input type="text" class="form-control color-text" id="editTextColorText" readonly>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Position</label>
              <select name="position" id="editPosition" class="form-select">
                <option value="top">Top</option>
                <option value="bottom">Bottom</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Link URL</label>
              <input type="url" name="linkUrl" id="editLinkUrl" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Link Text</label>
              <input type="text" name="linkText" id="editLinkText" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Start Date</label>
              <input type="datetime-local" name="startDate" id="editStartDate" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">End Date</label>
              <input type="datetime-local" name="endDate" id="editEndDate" class="form-control">
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="editIsActive" name="isActive">
                <label class="form-check-label" for="editIsActive">Active</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="editAllowDismiss" name="allowDismiss">
                <label class="form-check-label" for="editAllowDismiss">Allow Dismiss</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i> Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const basePath = '${basePath}';
  const token = '${token || ''}';
  const industries = ${JSON.stringify(industries || [])};
  const announcements = ${JSON.stringify(announcements || [])};
  const filters = ${JSON.stringify(filters || {})};

  function populateIndustryDropdowns() {
    const selects = ['industryFilter', 'addIndustrySelect', 'editIndustrySelect'];
    selects.forEach(selectId => {
      const select = document.getElementById(selectId);
      if (!select) return;
      industries.forEach(ind => {
        const option = document.createElement('option');
        option.value = ind.id;
        option.textContent = ind.name;
        if (selectId === 'industryFilter' && filters.industryId === ind.id) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    });
  }

  function renderAnnouncements() {
    const tbody = document.getElementById('announcementsTableBody');

    if (announcements.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="bi bi-megaphone fs-1 d-block mb-2"></i>No announcements found.<br><small>Create your first announcement to get started.</small></td></tr>';
      return;
    }

    let html = '';
    announcements.forEach((ann, index) => {
      const industryName = ann.industry ? ann.industry.name : 'All Industries';
      const now = new Date();
      const startDate = ann.startDate ? new Date(ann.startDate) : null;
      const endDate = ann.endDate ? new Date(ann.endDate) : null;

      let status = ann.isActive ? 'Active' : 'Inactive';
      let statusClass = ann.isActive ? 'bg-success' : 'bg-secondary';

      if (ann.isActive) {
        if (startDate && startDate > now) {
          status = 'Scheduled';
          statusClass = 'bg-warning text-dark';
        } else if (endDate && endDate < now) {
          status = 'Expired';
          statusClass = 'bg-danger';
        }
      }

      const scheduleText = [];
      if (startDate) scheduleText.push('From: ' + startDate.toLocaleDateString());
      if (endDate) scheduleText.push('To: ' + endDate.toLocaleDateString());

      html += '<tr>';
      html += '<td><i class="bi bi-grip-vertical text-muted" style="cursor: grab;"></i></td>';
      html += '<td>';
      html += '<div class="d-flex align-items-center">';
      html += '<span class="d-inline-block rounded me-2 p-2" style="background: ' + ann.bgColor + '; color: ' + ann.textColor + '"><i class="' + ann.icon + '"></i></span>';
      html += '<div><div style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + ann.text + '</div>';
      if (ann.linkUrl) html += '<small class="text-muted"><i class="bi bi-link me-1"></i>' + ann.linkText + '</small>';
      html += '</div></div></td>';
      html += '<td><span class="badge bg-light text-dark">' + industryName + '</span></td>';
      html += '<td><small class="text-muted">' + (scheduleText.length > 0 ? scheduleText.join('<br>') : 'Always') + '</small></td>';
      html += '<td><span class="badge ' + statusClass + '">' + status + '</span></td>';
      html += '<td>';
      html += '<button class="btn btn-sm btn-outline-secondary me-1" onclick="editAnnouncement(\\'' + ann.id + '\\')" data-bs-toggle="tooltip" title="Edit"><i class="bi bi-pencil"></i></button>';
      html += '<button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(\\'' + ann.id + '\\')" data-bs-toggle="tooltip" title="Delete"><i class="bi bi-trash"></i></button>';
      html += '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
    initTooltips();
  }

  function editAnnouncement(id) {
    const ann = announcements.find(a => a.id === id);
    if (!ann) return;

    document.getElementById('editId').value = ann.id;
    document.getElementById('editIndustrySelect').value = ann.industryId || '';
    document.getElementById('editIcon').value = ann.icon || 'bi-megaphone';
    document.getElementById('editText').value = ann.text;
    document.getElementById('editBgColor').value = ann.bgColor || '#2563eb';
    document.getElementById('editBgColorText').value = ann.bgColor || '#2563eb';
    document.getElementById('editTextColor').value = ann.textColor || '#ffffff';
    document.getElementById('editTextColorText').value = ann.textColor || '#ffffff';
    document.getElementById('editPosition').value = ann.position || 'top';
    document.getElementById('editLinkUrl').value = ann.linkUrl || '';
    document.getElementById('editLinkText').value = ann.linkText || '';
    document.getElementById('editStartDate').value = ann.startDate ? ann.startDate.substring(0, 16) : '';
    document.getElementById('editEndDate').value = ann.endDate ? ann.endDate.substring(0, 16) : '';
    document.getElementById('editIsActive').checked = ann.isActive;
    document.getElementById('editAllowDismiss').checked = ann.allowDismiss;

    const modal = new bootstrap.Modal(document.getElementById('editAnnouncementModal'));
    modal.show();
  }

  async function deleteAnnouncement(id) {
    if (!confirm('Are you sure you want to delete this announcement?')) return;

    try {
      const res = await fetch(basePath + '/api/v1/announcements/' + id + '?token=' + token, { method: 'DELETE' });
      if (res.ok) {
        location.reload();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to delete announcement');
      }
    } catch (err) {
      alert('Error deleting announcement');
    }
  }

  function initTooltips() {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });
  }

  // Color picker sync
  document.querySelectorAll('input[type="color"]').forEach(colorInput => {
    colorInput.addEventListener('input', (e) => {
      const textInput = e.target.parentElement.querySelector('.color-text');
      if (textInput) textInput.value = e.target.value;
    });
  });

  // Live preview for add form
  const addForm = document.getElementById('addAnnouncementForm');
  if (addForm) {
    addForm.querySelector('[name="text"]').addEventListener('input', (e) => {
      document.getElementById('addPreviewText').textContent = e.target.value || 'Enter announcement text...';
    });
    addForm.querySelector('[name="bgColor"]').addEventListener('input', (e) => {
      document.getElementById('addPreview').style.background = e.target.value;
    });
    addForm.querySelector('[name="textColor"]').addEventListener('input', (e) => {
      document.getElementById('addPreview').style.color = e.target.value;
    });
    addForm.querySelector('[name="linkText"]').addEventListener('input', (e) => {
      const link = document.getElementById('addPreviewLink');
      link.textContent = e.target.value;
      link.style.display = e.target.value ? 'inline' : 'none';
    });
  }

  // Form submissions
  document.getElementById('addAnnouncementForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.isActive = form.isActive.checked;
    data.allowDismiss = form.allowDismiss.checked;

    try {
      const res = await fetch(basePath + '/api/v1/announcements?token=' + token, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        location.reload();
      } else {
        const result = await res.json();
        alert(result.error || 'Failed to create announcement');
      }
    } catch (err) {
      alert('Error creating announcement');
    }
  });

  document.getElementById('editAnnouncementForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const id = form.id.value;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    data.isActive = form.isActive.checked;
    data.allowDismiss = form.allowDismiss.checked;

    try {
      const res = await fetch(basePath + '/api/v1/announcements/' + id + '?token=' + token, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        location.reload();
      } else {
        const result = await res.json();
        alert(result.error || 'Failed to update announcement');
      }
    } catch (err) {
      alert('Error updating announcement');
    }
  });

  document.addEventListener('DOMContentLoaded', () => {
    populateIndustryDropdowns();
    renderAnnouncements();
  });
</script>

` }) %>
